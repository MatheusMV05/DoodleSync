rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is the owner of the resource
    function isOwner(resourceData) {
      return isAuthenticated() && resourceData.ownerId == request.auth.uid;
    }

    // Users collection
    // Users can read and write only their own profile
    match /users/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // Folders collection
    // Users can read/write folders they own
    match /folders/{folderId} {
      allow read: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
    }

    // Drawings collection (Canvas)
    match /drawings/{drawingId} {
      
      // Helper to check specific permissions on the drawing
      function hasAccess(role) {
        let accessControl = resource.data.accessControl;
        // Check if user is explicitly listed with the required role
        return isAuthenticated() && 
               accessControl.users[request.auth.uid] in [role, 'owner', 'editor']; 
               // Note: 'viewer' role would not pass if we checked for 'editor'
      }

      function isPublic(mode) {
        let publicAccess = resource.data.accessControl.publicLinkAccess;
        return publicAccess == mode || publicAccess == 'edit'; 
        // If mode is 'view', 'edit' also grants view access.
      }

      // READ: Allowed if:
      // 1. User is the owner (checked via accessControl or ownerId)
      // 2. User is listed in accessControl.users
      // 3. Public link is 'view' or 'edit'
      allow read: if 
        (isAuthenticated() && resource.data.ownerId == request.auth.uid) ||
        (isAuthenticated() && request.auth.uid in resource.data.accessControl.users) ||
        resource.data.accessControl.publicLinkAccess in ['view', 'edit'];

      // CREATE: Allowed if user is authenticated and sets themselves as owner
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;

      // UPDATE: Allowed if:
      // 1. User is owner
      // 2. User has 'editor' or 'owner' role in accessControl
      // 3. Public link is 'edit'
      allow update: if 
        (isAuthenticated() && resource.data.ownerId == request.auth.uid) ||
        (isAuthenticated() && resource.data.accessControl.users[request.auth.uid] in ['owner', 'editor']) ||
        resource.data.accessControl.publicLinkAccess == 'edit';

      // DELETE: Only owner can delete
      allow delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
    }
  }
}
